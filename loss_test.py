import torch
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim

import numpy as np

from src.components.losses.loss import AggregationLoss


# def forward(self, pred_similarities, regions_mask, kernels_mask)


if __name__ == "__main__":
    criteria = AggregationLoss(sigma_agg=0.5)
    
    BS = 2
    
    array = np.array([[1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0]])
    
    masks = torch.Tensor([[[[1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0]]],
                          
                          [[[1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0]]]]).int()
    
    masks = torch.cat(BS // 2 * [masks], dim=0)
    
    masks_region = torch.Tensor([[[[1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0]]],
                                 
                                 [[[1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0],
                     [1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0],
                     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0],
                     [0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                     [0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0]]]]).int()
    
    masks_region = torch.cat(BS // 2 * [masks_region], dim=0)
    print(f"==>> masks_region.shape: {masks_region.shape}")
    
    
    pred_similarities = torch.randn((BS,4,6,8))
    
    loss = criteria(pred_similarities, masks_region, masks)
    print(f"==>> loss: {loss}")
    
